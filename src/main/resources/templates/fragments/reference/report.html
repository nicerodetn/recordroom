<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div id="b-homedb" th:fragment="tabler">
    <div class="my-5">
        <h3 style="font-size:32px;" class="text-center mb-3 b-latest-data">Reference File Report</h3>

        <script th:inline="javascript">
            var g_fileTypes = /*[[${fileTypes}]]*/ {};
            var g_table;

            function initializeDataTable(selectedType) {
                var ajaxUrl = /*[[@{/reference/load_reference_data}]]*/ '';
                if (selectedType) {
                    ajaxUrl += '?fileType=' + selectedType;
                }

                g_table = $('#example1').DataTable({
                    "processing": true,
                    "serverSide": true,
                    "ajax": {
                        "url": ajaxUrl,
                        "type": "POST",
                        "contentType": "application/json",
                        "data": function (d) {
                            return JSON.stringify(d);
                        }
                    },
                    "columns": [
                        { "data": null, "searchable": false, "orderable": false },
                        { "data": "type" },
                        { "data": "serialNo" },
                        { "data": "description" },
                        { "data": "serial_no_user" },
                        { "data": "file_year" },
                        { "data": "out_sectionDealingHandName" },
                        { "data": "out_sectionDealingHandPhoneNo" },
                        { "data": "created_date" }
                    ],
                    dom: 'lBfrtip',
                    buttons: [
                        {
                            extend: 'pdfHtml5',
                            orientation: 'landscape',
                            text: 'Export PDF',
                            className: 'btn btn-secondary mr-2',
                            filename: 'Reference_File_Report',
                            title: '',
                            customize: function (doc) {
                                doc.pageMargins = [40, 70, 40, 60];
                                doc.defaultStyle.fontSize = 10;
                                doc.content.unshift({
                                    margin: [0, 0, 0, 12],
                                    stack: [
                                        { text: 'Erode District Administration', fontSize: 16, bold: true, alignment: 'center' },
                                        { text: 'Record Room', fontSize: 11, alignment: 'center' },
                                        { text: 'REFERENCE FILE REPORT', fontSize: 13, bold: true, alignment: 'center', margin: [0, 6, 0, 0] },
                                        { text: 'Generated on: ' + new Date().toLocaleDateString(), fontSize: 9, alignment: 'center' }
                                    ]
                                });
                                doc.styles.tableHeader = { fillColor: '#4CAF50', color: 'white', bold: true, alignment: 'center' };
                            },
                            exportOptions: {
                                columns: ':visible',
                                format: { body: function (data, row, col, node) { return (col === 0 || col === 1) ? $(node).text() : data; } }
                            }
                        },
                        {
                            extend: 'excelHtml5',
                            text: 'Export Excel',
                            className: 'btn btn-secondary',
                            filename: 'Reference_File_Report',
                            title: '',
                            sheetName: 'Report',
                            customize: function (xlsx) {
                                var sheet = xlsx.xl.worksheets['sheet1.xml'];
                                var $sheet = $(sheet);
                                var styles = xlsx.xl['styles.xml'];
                                $(styles).find('xf').each(function () {
                                    var xf = $(this);
                                    if (xf.attr('xfId') === '0') {
                                        xf.attr('applyAlignment', '1');
                                        if (!xf.find('alignment').length) {
                                            xf.append('<alignment horizontal="center" vertical="center"/>');
                                        }
                                    }
                                });
                                $('row', sheet).each(function () {
                                    var r = parseInt($(this).attr('r'));
                                    $(this).attr('r', r + 5);
                                    $('c', this).each(function () {
                                        var ref = $(this).attr('r');
                                        var col = ref.replace(/[0-9]/g, '');
                                        $(this).attr('r', col + (r + 5));
                                    });
                                });
                                var today = new Date().toLocaleDateString();
                                var sheetData = $('sheetData', sheet);
                                sheetData.prepend(
                                    '<row r="1" ht="28" customHeight="1"><c r="A1" t="inlineStr" s="51"><is><t>Erode District Administration</t></is></c></row>' +
                                    '<row r="2" ht="22" customHeight="1"><c r="A2" t="inlineStr" s="51"><is><t>Record Room</t></is></c></row>' +
                                    '<row r="3" ht="20" customHeight="1"><c r="A3" t="inlineStr" s="51"><is><t>Generated on: ' + today + '</t></is></c></row>' +
                                    '<row r="4" ht="26" customHeight="1"><c r="A4" t="inlineStr" s="51"><is><t>REFERENCE FILE REPORT</t></is></c></row>' +
                                    '<row r="5"></row>'
                                );
                                var mergeCells = $sheet.find('mergeCells');
                                if (!mergeCells.length) {
                                    mergeCells = $('<mergeCells count="0"/>');
                                    $sheet.append(mergeCells);
                                }
                                mergeCells.append('<mergeCell ref="A1:I1"/>');
                                mergeCells.append('<mergeCell ref="A2:I2"/>');
                                mergeCells.append('<mergeCell ref="A3:I3"/>');
                                mergeCells.append('<mergeCell ref="A4:I4"/>');
                                var currentCount = parseFloat(mergeCells.attr('count')) || 0;
                                mergeCells.attr('count', currentCount + 4);
                                var colWidths = [];
                                $('row', sheet).each(function () {
                                    var r = parseInt($(this).attr('r'));
                                    if (r > 5) {
                                        $('c', this).each(function (i) {
                                            var text = $('t', this).text();
                                            var len = text ? text.length : 0;
                                            colWidths[i] = Math.max(colWidths[i] || 10, len);
                                        });
                                    }
                                });
                                var colsXml = '<cols>';
                                colWidths.forEach(function (w, i) {
                                    colsXml += '<col min="' + (i + 1) + '" max="' + (i + 1) + '" width="' + Math.min(w + 5, 50) + '"/>';
                                });
                                colsXml += '</cols>';
                                $sheet.find('worksheet').prepend(colsXml);
                            },
                            exportOptions: {
                                columns: ':visible',
                                format: { body: function (data, row, col, node) { return (col === 0 || col === 1) ? $(node).text() : data; } }
                            }
                        }
                    ],
                    "responsive": true,
                    "lengthChange": false,
                    "pageLength": 100,
                    "ordering": false,
                    "autoWidth": false,
                    "destroy": true,
                    "fnRowCallback": function(nRow, aData, iDisplayIndex) {
                        var info = g_table.page.info();
                        var page = info.page;
                        var length = info.length;
                        var index = (page * length) + (iDisplayIndex + 1);
                        $('td:eq(0)', nRow).html(index);
                        var fileTypeInt = aData.type;
                        $('td:eq(1)', nRow).html(g_fileTypes[fileTypeInt] || 'N/A');
                    }
                });

                var filterHtml = `
                    <div class="d-inline-flex align-items-center" style="margin-right: 15px;">
                        <label for="fileTypeFilter" class="mr-3 mb-0">Filter by File Type:</label>
                        <select name="fileType" id="fileTypeFilter" class="form-control form-control-sm" style="width: auto;">
                            <option value="">-- All Types --</option>
                        </select>
                        <a href="#" id="clearFilter" class="btn btn-secondary btn-sm ml-2">Clear</a>
                    </div>
                `;

                if ($('#fileTypeFilter').length === 0) {
                    $('#example1_filter').prepend(filterHtml);
                }

                var $select = $('#fileTypeFilter');
                $select.find('option:gt(0)').remove();
                Object.keys(g_fileTypes).forEach(function(key) {
                    var value = g_fileTypes[key];
                    var $option = $('<option></option>').attr('value', key).text(value);
                    $select.append($option);
                });

                if (selectedType) {
                    $select.val(selectedType);
                } else {
                    $select.val('');
                }

                $('#example1_filter input[type="search"]')
                    .attr('type', 'number')
                    .attr('placeholder', 'Search by Serial No...');
            }

            $(document).ready(function () {
                var initialSelectedType = /*[[${selectedType}]]*/ null;
                initializeDataTable(initialSelectedType);
            });

            $(document).on('change', '#fileTypeFilter', function() {
                var selectedType = $(this).val();
                g_table.destroy();
                initializeDataTable(selectedType);
            });

            $(document).on('click', '#clearFilter', function(e) {
                e.preventDefault();
                g_table.destroy();
                initializeDataTable(null);
            });
        </script>

        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <table id="example1" class="table table-bordered table-striped">
                                <thead>
                                <tr>
                                    <th>Sr. No.</th>
                                    <th>File Type</th>
                                    <th>Serial No</th>
                                    <th>File Description</th>
                                    <th>File Serial No</th>
                                    <th>File Year</th>
                                    <th>Section Dealing Hand Name</th>
                                    <th>Section Dealing Phone No</th>
                                    <th>Out Ward Date</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="ref, iterStat : ${references}">
                                    <td th:text="${iterStat.index + 1}"></td>
                                    <td th:text="${ref.type}"></td>
                                    <td th:text="${ref.serialNo}"></td>
                                    <td th:text="${ref.description}"></td>
                                    <td th:text="${ref.serial_no_user}"></td>
                                    <td th:text="${ref.file_year}"></td>
                                    <td th:text="${ref.out_sectionDealingHandName}"></td>
                                    <td th:text="${ref.out_sectionDealingHandPhoneNo}"></td>
                                    <td th:text="${ref.created_date}"></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</html>