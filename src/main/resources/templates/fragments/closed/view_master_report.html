<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div id="b-homedb"  th:fragment="tabler">
    <div class="my-5" >
        <h3 style="font-size:32px;" class="text-center mb-3 b-latest-data">Master File's List </h3>

        <script th:inline="javascript">

            var g_categories = /*[[${categories}]]*/ [];
            var g_table;

            function initializeDataTable(selectedCategory) {

                var ajaxUrl = /*[[@{/circulation/load_master_data}]]*/ '';
                if (selectedCategory) {
                    ajaxUrl += '?sectionCategory=' + selectedCategory;
                }

                g_table = $('#example1').DataTable({
                    processing: true,
                    serverSide: true,
                    ajax: {
                        url: ajaxUrl,
                        type: "POST",
                        contentType: "application/json",
                        data: function (d) {
                            return JSON.stringify(d);
                        }
                    },
                    columns: [
                        { data: null, searchable: false, orderable: false },
                        { data: "fileType" },
                        { data: "drSerialNo" },
                        { data: "rackDetails" },
                        { data: "dr_year" },
                        { data: "section" },
                        { data: "total_volume" },
                        { data: "total_pages" },
                        { data: "fileClosingDate" },
                        { data: "handingOverDate" },
                        { data: "remarks" },
                        { data: "sectionDealingHandName" },
                        { data: "sectionDealingHandPhoneNo" },
                        { data: "recordRoomDealingHandName" }
                    ],

                    dom: 'lBfrtip',

                    buttons: [
                        /* ================= PDF EXPORT ================= */
                        {
                            extend: 'pdfHtml5',
                            orientation: 'landscape',
                            text: 'Export PDF',
                            className: 'btn btn-secondary mr-2',
                            filename: 'Master_File_Report',
                            title: '', // <--- THIS REMOVES "Record Room | Dashboard"
                            customize: function (doc) {
                                doc.pageMargins = [40, 70, 40, 60];
                                doc.defaultStyle.fontSize = 10;

                                // Add Custom Header
                                doc.content.unshift({
                                    margin: [0, 0, 0, 12],
                                    stack: [
                                        { text: 'Erode District Administration', fontSize: 16, bold: true, alignment: 'center' },
                                        { text: 'Record Room', fontSize: 11, alignment: 'center' },
                                        { text: 'MASTER FILE REPORT', fontSize: 13, bold: true, alignment: 'center', margin: [0, 6, 0, 0] },
                                        { text: 'Generated on: ' + new Date().toLocaleDateString(), fontSize: 9, alignment: 'center' }
                                    ]
                                });

                                doc.styles.tableHeader = { fillColor: '#4CAF50', color: 'white', bold: true, alignment: 'center' };
                            },
                            exportOptions: {
                                columns: ':visible',
                                format: { body: function (data, row, col, node) { return col === 0 ? $(node).text() : data; } }
                            }
                        },

                        /* ================= EXCEL EXPORT ================= */
                        {
                            extend: 'excelHtml5',
                            text: 'Export Excel',
                            className: 'btn btn-secondary',
                            filename: 'Master_File_Report',
                            title: '', // <--- THIS REMOVES "Record Room | Dashboard"
                            sheetName: 'Report',
                            customize: function (xlsx) {
                                var sheet = xlsx.xl.worksheets['sheet1.xml'];
                                var $sheet = $(sheet);

                                // 1. Force Center Alignment in Styles
                                var styles = xlsx.xl['styles.xml'];
                                $(styles).find('xf').each(function () {
                                    var xf = $(this);
                                    if (xf.attr('xfId') === '0') {
                                        xf.attr('applyAlignment', '1');
                                        if (!xf.find('alignment').length) {
                                            xf.append('<alignment horizontal="center" vertical="center"/>');
                                        }
                                    }
                                });

                                // 2. Shift Existing Data Down by 5 Rows
                                $('row', sheet).each(function () {
                                    var r = parseInt($(this).attr('r'));
                                    $(this).attr('r', r + 5);
                                    $('c', this).each(function () {
                                        var ref = $(this).attr('r');
                                        var col = ref.replace(/[0-9]/g, '');
                                        $(this).attr('r', col + (r + 5));
                                    });
                                });

                                // 3. Add Custom Header Rows (1-5)
                                var today = new Date().toLocaleDateString();
                                var sheetData = $('sheetData', sheet);

                                sheetData.prepend(
                                    '<row r="1" ht="28" customHeight="1"><c r="A1" t="inlineStr" s="51"><is><t>Erode District Administration</t></is></c></row>' +
                                    '<row r="2" ht="22" customHeight="1"><c r="A2" t="inlineStr" s="51"><is><t>Record Room</t></is></c></row>' +
                                    '<row r="3" ht="20" customHeight="1"><c r="A3" t="inlineStr" s="51"><is><t>Generated on: ' + today + '</t></is></c></row>' +
                                    '<row r="4" ht="26" customHeight="1"><c r="A4" t="inlineStr" s="51"><is><t>MASTER FILE REPORT</t></is></c></row>' +
                                    '<row r="5"></row>'
                                );

                                // 4. MERGE CELLS (A to N)
                                var mergeCells = $sheet.find('mergeCells');
                                if (!mergeCells.length) {
                                    mergeCells = $('<mergeCells count="0"/>');
                                    $sheet.append(mergeCells);
                                }

                                // Explicitly merge rows 1, 2, 3, and 4 from Column A to N (14 Columns)
                                mergeCells.append('<mergeCell ref="A1:N1"/>');
                                mergeCells.append('<mergeCell ref="A2:N2"/>');
                                mergeCells.append('<mergeCell ref="A3:N3"/>');
                                mergeCells.append('<mergeCell ref="A4:N4"/>');

                                var currentCount = parseFloat(mergeCells.attr('count')) || 0;
                                mergeCells.attr('count', currentCount + 4);

                                // 5. Adjust Column Widths (Skipping Header Rows 1-5 to fix huge column A)
                                var colWidths = [];
                                $('row', sheet).each(function () {
                                    var r = parseInt($(this).attr('r'));
                                    if (r > 5) {
                                        $('c', this).each(function (i) {
                                            var text = $('t', this).text();
                                            var len = text ? text.length : 0;
                                            colWidths[i] = Math.max(colWidths[i] || 10, len);
                                        });
                                    }
                                });
                                var colsXml = '<cols>';
                                colWidths.forEach(function (w, i) {
                                    colsXml += '<col min="' + (i + 1) + '" max="' + (i + 1) + '" width="' + Math.min(w + 5, 50) + '"/>';
                                });
                                colsXml += '</cols>';
                                $sheet.find('worksheet').prepend(colsXml);
                            },
                            exportOptions: {
                                columns: ':visible',
                                format: { body: function (data, row, col, node) { return col === 0 ? $(node).text() : data; } }
                            }
                        }
                    ],

                    responsive: true,
                    lengthChange: false,
                    pageLength: 100,
                    autoWidth: false,
                    ordering: false,
                    searching: true,
                    destroy: true,

                    fnRowCallback: function (nRow, aData, iDisplayIndex) {
                        var info = g_table.page.info();
                        var index = (info.page * info.length) + (iDisplayIndex + 1);
                        $('td:eq(0)', nRow).html(index);

                        if (aData.fileClosingDate) {
                            try { $('td:eq(8)', nRow).html(new Date(aData.fileClosingDate).toLocaleDateString('en-GB')); } catch(e) {}
                        }
                        if (aData.handingOverDate) {
                            try { $('td:eq(9)', nRow).html(new Date(aData.handingOverDate).toLocaleDateString('en-GB')); } catch(e) {}
                        }
                    },

                    initComplete: function () {
                        var filterHtml = `
                            <div class="d-inline-flex align-items-center" style="margin-right:15px;">
                                <label class="mr-2 mb-0">Filter by Section:</label>
                                <select id="sectionFilter" class="form-control form-control-sm" style="width:auto">
                                    <option value="">ALL</option>
                                </select>
                                <a href="#" id="clearFilter" class="btn btn-secondary btn-sm ml-2">Clear</a>
                            </div>
                        `;

                        if (!$('#sectionFilter').length) {
                            $('#example1_filter').prepend(filterHtml);
                        }

                        var $select = $('#sectionFilter');
                        g_categories.forEach(function(c) { $select.append('<option value="' + c + '">' + c + '</option>'); });

                        $('#example1_filter input[type="search"]')
                            .attr('type', 'number')
                            .attr('placeholder', 'Search by DR Serial No...');
                    }
                });
            }

            $(document).ready(function () {
                var initialSelectedCategory = /*[[${selectedCategory}]]*/ null;
                initializeDataTable(initialSelectedCategory);
            });

            $(document).on('change', '#sectionFilter', function () {
                g_table.destroy();
                initializeDataTable($(this).val());
            });

            $(document).on('click', '#clearFilter', function (e) {
                e.preventDefault();
                g_table.destroy();
                initializeDataTable(null);
            });

        </script>



        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"></h3>
                        </div>
                        <div class="card-body">
                            <table id="example1" class="table table-bordered table-striped">
                                <thead>
                                <tr>
                                    <th>Sr. No.</th>
                                    <th>File Type (Year's)</th>
                                    <th>DR Serial No</th>
                                    <th>Rack Details</th>
                                    <th>DR Year</th>
                                    <th>Section</th>
                                    <th>Volumes</th>
                                    <th>Pages</th>
                                    <th>File Closing Date</th>
                                    <th>Handing Over Date</th>
                                    <th>Remarks</th>
                                    <th>Section Dealing Hand Name</th>
                                    <th>Section Dealing Hand Phone No</th>
                                    <th>Record Room Dealing Hand Name</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
</html>