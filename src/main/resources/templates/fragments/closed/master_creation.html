<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">


<div  th:fragment="loadFormFragment">
    <div class="my-5" id="b-homedb">

        <div class="container">

            <h3 style="font-size:32px;" class="text-center col-12 b-latest-data">File Master Creation</h3>
            <div class="row">
                <div class="container-fluid add-form-list">
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="card">
                                <div class="card-body">

                                    <form th:object="${record}" method="post"
                                          hx-post="/record/circulation/save"
                                          hx-target="#b-homedb"
                                          hx-swap="outerHTML"
                                          class="row g-3 border p-3 rounded bg-light shadow-sm"
                                          id="recordForm">
                                        <!-- 1. File Type -->

                                        <div style="padding-top: 17px;" class="col-12">
                                            <label class="form-label fw-bold">1. File Type</label><br>
                                            <select class="form-select" th:field="*{fileType}" required>
                                                <option value="">-- Select Section --</option>
                                                <option value="1">1 (L.Dis)</option>
                                                <option value="3">3 (K.Dis)</option>
                                                <option value="10">10 (D.Dis)</option>
                                                <option value="30">Permanent (R.Dis)</option>
                                            </select>
                                            <div class="invalid-feedback">
                                                Please select a section before saving.
                                            </div>
                                        </div>

                                        <div class="col-12">
                                            <label class="form-label fw-bold">2. Year</label>
                                            <input type="number" class="form-control" id="yearInput" th:field="*{dr_year}" name="year" min="1900" max="2099" placeholder="Enter year" required>
                                        </div>

                                        <!-- 2. DR Serial No -->
                                        <div class="col-12">
                                            <label class="form-label fw-bold">3. DR Serial No</label>
                                            <input type="number" class="form-control" th:field="*{drSerialNo}" placeholder="Enter DR serial number">
                                        </div>

                                        <div class="col-12">
                                            <label class="form-label fw-bold">4 .Total No of Volume</label>
                                            <input type="number" class="form-control" th:field="*{total_volume}" placeholder="Enter Total No of Volume">
                                        </div>

                                        <div class="col-12">
                                            <label class="form-label fw-bold">5. Total No of Pages</label>
                                            <input type="number" class="form-control" th:field="*{total_pages}" placeholder="Enter Total No of Pages">
                                        </div>


                                        <div class="col-12">
                                            <label class="form-label fw-bold"> 6. Total No of Note Pages</label>
                                            <input type="number" class="form-control" th:field="*{note_pages}" placeholder="Enter Total No of Note Pages">
                                        </div>


                                        <div style="padding-top: 17px;" class="col-12">
                                            <label class="form-label fw-bold">7. Section</label><br>
                                            <select class="form-select" th:field="*{section}" required>
                                                <option value="">-- Select Section --</option>
                                                <option th:each="sec: ${sections}"
                                                        th:value="${sec.id}"
                                                        th:text="${sec.code + ' - ' + sec.section}"></option>
                                            </select>
                                            <div class="invalid-feedback">
                                                Please select a section before saving.
                                            </div>
                                        </div>


                                        <div class="col-12">
                                            <label class="form-label fw-bold">8. File Closing Date</label>
                                            <input type="date" class="form-control" th:field="*{fileClosingDate}" required>
                                        </div>


                                        <div class="col-12">
                                            <label class="form-label fw-bold">9. Handing Over Date</label>
                                            <input type="date" class="form-control" th:field="*{handingOverDate}" required>
                                        </div>


                                        <div class="col-12">
                                            <label class="form-label fw-bold">10. Rack Details</label>
                                            <input type="number" class="form-control" th:field="*{rackDetails}" placeholder="Enter rack no/details" required>
                                        </div>


                                        <div class="col-12">
                                            <label class="form-label fw-bold">11. Remarks</label>
                                            <textarea class="form-control" th:field="*{remarks}" rows="2" placeholder="Enter remarks"></textarea>
                                        </div>


                                        <div class="col-12">
                                            <label class="form-label fw-bold">12a) Section Dealing Hand Name</label>
                                            <input type="text" class="form-control" th:field="*{sectionDealingHandName}" placeholder="Enter dealing hand name"  required>
                                        </div>


                                        <div class="col-12">
                                            <label class="form-label fw-bold">12b) Section Dealing Hand Phone No</label>
                                            <input type="text" pattern="\d{10}"
                                                   maxlength="10"
                                                   minlength="10"
                                                   oninput="this.value = this.value.replace(/\D/g, '').slice(0, 10)"  class="form-control" th:field="*{sectionDealingHandPhoneNo}" placeholder="Enter phone no"  required>
                                        </div>

                                        <div style="padding-top: 17px;" class="col-12">
                                            <label class="form-label fw-bold">13. Record Room Dealing Hand Name</label><br>
                                            <select class="form-select" th:field="*{recordRoomDealingHandName}" required>
                                                <option value="">-- Select Section--</option>
                                                <option value="M. Ramesh">Shri M. Ramesh</option>
                                                <option value="Balasubramaniyan">Shri S. Balasubramaniyan</option>
                                                <option value="N. Karuppusamy">Shri N. Karuppusamy</option>
                                            </select>
                                            <div class="invalid-feedback">
                                                Please select a section before saving.
                                            </div>
                                        </div>



                                        <!-- Submit Button -->
                                        <div class="d-grid mt-4">
                                            <button type="submit" class="btn btn-primary btn-lg">ðŸ’¾ Save Record</button>
                                        </div>
                                    </form>

                                    <div th:if="${successMessage}"
                                         class="alert alert-success alert-dismissible fade show text-center"
                                         id="successMsg"
                                         role="alert"
                                         th:text="${successMessage}">
                                    </div>

                                    <script th:inline="javascript">
                                        $(document).ready(function() {
                                            // 1. Get the correct base URL using Thymeleaf (Handles '/record' context path automatically)
                                            var baseApiUrl = /*[[@{/circulation/api/section/}]]*/ '/circulation/api/section/';

                                            // 2. Use Event Delegation (Use $(document).on) for HTMX compatibility
                                            $(document).on('change', '#section', function() {
                                                var sectionId = $(this).val();

                                                // Debugging: Check console to see if the URL is correct now
                                                console.log("Section ID:", sectionId);
                                                console.log("Fetching URL:", baseApiUrl + sectionId);

                                                if (sectionId) {
                                                    $.get(baseApiUrl + sectionId, function(data) {
                                                        if (data) {
                                                            $('#sectionDealingHandName').val(data.sectionDealingHandName);
                                                            $('#sectionDealingHandPhoneNo').val(data.sectionDealingHandPhoneNo);
                                                        }
                                                    }).fail(function() {
                                                        console.error("Failed to fetch section details.");
                                                    });
                                                } else {
                                                    $('#sectionDealingHandName').val('');
                                                    $('#sectionDealingHandPhoneNo').val('');
                                                }
                                            });

                                            // Auto-hide success message
                                            setTimeout(() => {
                                                let msg = document.getElementById("successMsg");
                                                if (msg) {
                                                    msg.classList.remove("show");
                                                    msg.remove();
                                                }
                                            }, 3000);
                                        });
                                    </script>


                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="response"></div>
                </div>
            </div>
        </div>

    </div>
</div>
</html>