<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div id="b-homedb" th:fragment="tabler">
    <div class="my-5">
        <h3 style="font-size:32px;" class="text-center mb-3 b-latest-data">Old Register Transaction Details</h3>

        <script th:inline="javascript">
            var g_table;

            function initializeDataTable() {
                var ajaxUrl = /*[[@{/oldregister/load_transactions_data}]]*/ '';

                g_table = $('#example1').DataTable({
                    "processing": true,
                    "serverSide": true,
                    "ajax": {
                        "url": ajaxUrl,
                        "type": "POST",
                        "contentType": "application/json",
                        "data": function (d) {
                            return JSON.stringify(d);
                        }
                    },
                    "columns": [
                        { "data": null, "searchable": false, "orderable": false },
                        { "data": "master.record_serial_no" },
                        { "data": "master.year" },
                        { "data": "dateOfOutGoing" },
                        { "data": "purposeTakingOut" },
                        { "data": "sectionPersonName_out" },
                        { "data": "sectionPersonName_number" },
                        { "data": "recordPersonName_out" },
                        { "data": "dateOfReturn" },
                        { "data": "sectionPersonName_in" },
                        { "data": "sectionPersonPhNumber_in" },
                        { "data": "recordPersonName_in" },
                        { "data": "transactionDate" }
                    ],
                    dom:'lBfrtip',
                    buttons: [
                        {
                            extend: 'pdfHtml5',
                            text: 'Export PDF',
                            orientation: 'landscape',
                            className: 'btn btn-secondary mr-2',
                            filename: 'Old_Register_Transactions',
                            title: '',
                            customize: function (doc) {
                                doc.pageMargins = [40, 70, 40, 60];
                                doc.defaultStyle.fontSize = 10;
                                doc.content.unshift({
                                    margin: [0, 0, 0, 12],
                                    stack: [
                                        { text: 'Erode District Administration', fontSize: 16, bold: true, alignment: 'center' },
                                        { text: 'Record Room', fontSize: 11, alignment: 'center' },
                                        { text: 'OLD REGISTER TRANSACTION DETAILS', fontSize: 13, bold: true, alignment: 'center', margin: [0, 6, 0, 0] },
                                        { text: 'Generated on: ' + new Date().toLocaleDateString(), fontSize: 9, alignment: 'center' }
                                    ]
                                });
                                doc.styles.tableHeader = { fillColor: '#4CAF50', color: 'white', bold: true, alignment: 'center' };
                            },
                            exportOptions: {
                                columns: ':visible',
                                format: { body: function (data, row, col, node) { return col === 0 ? $(node).text() : data; } }
                            }
                        },
                        {
                            extend: 'excelHtml5',
                            text: 'Export Excel',
                            className: 'btn btn-secondary',
                            filename: 'Old_Register_Transactions',
                            title: '',
                            sheetName: 'Report',
                            customize: function (xlsx) {
                                var sheet = xlsx.xl.worksheets['sheet1.xml'];
                                var $sheet = $(sheet);
                                var styles = xlsx.xl['styles.xml'];
                                $(styles).find('xf').each(function () {
                                    var xf = $(this);
                                    if (xf.attr('xfId') === '0') {
                                        xf.attr('applyAlignment', '1');
                                        if (!xf.find('alignment').length) {
                                            xf.append('<alignment horizontal="center" vertical="center"/>');
                                        }
                                    }
                                });
                                $('row', sheet).each(function () {
                                    var r = parseInt($(this).attr('r'));
                                    $(this).attr('r', r + 5);
                                    $('c', this).each(function () {
                                        var ref = $(this).attr('r');
                                        var col = ref.replace(/[0-9]/g, '');
                                        $(this).attr('r', col + (r + 5));
                                    });
                                });
                                var today = new Date().toLocaleDateString();
                                var sheetData = $('sheetData', sheet);
                                sheetData.prepend(
                                    '<row r="1" ht="28" customHeight="1"><c r="A1" t="inlineStr" s="51"><is><t>Erode District Administration</t></is></c></row>' +
                                    '<row r="2" ht="22" customHeight="1"><c r="A2" t="inlineStr" s="51"><is><t>Record Room</t></is></c></row>' +
                                    '<row r="3" ht="20" customHeight="1"><c r="A3" t="inlineStr" s="51"><is><t>Generated on: ' + today + '</t></is></c></row>' +
                                    '<row r="4" ht="26" customHeight="1"><c r="A4" t="inlineStr" s="51"><is><t>OLD REGISTER TRANSACTION DETAILS</t></is></c></row>' +
                                    '<row r="5"></row>'
                                );
                                var mergeCells = $sheet.find('mergeCells');
                                if (!mergeCells.length) {
                                    mergeCells = $('<mergeCells count="0"/>');
                                    $sheet.append(mergeCells);
                                }
                                mergeCells.append('<mergeCell ref="A1:M1"/>');
                                mergeCells.append('<mergeCell ref="A2:M2"/>');
                                mergeCells.append('<mergeCell ref="A3:M3"/>');
                                mergeCells.append('<mergeCell ref="A4:M4"/>');
                                var currentCount = parseFloat(mergeCells.attr('count')) || 0;
                                mergeCells.attr('count', currentCount + 4);
                                var colWidths = [];
                                $('row', sheet).each(function () {
                                    var r = parseInt($(this).attr('r'));
                                    if (r > 5) {
                                        $('c', this).each(function (i) {
                                            var text = $('t', this).text();
                                            var len = text ? text.length : 0;
                                            colWidths[i] = Math.max(colWidths[i] || 10, len);
                                        });
                                    }
                                });
                                var colsXml = '<cols>';
                                colWidths.forEach(function (w, i) {
                                    colsXml += '<col min="' + (i + 1) + '" max="' + (i + 1) + '" width="' + Math.min(w + 5, 50) + '"/>';
                                });
                                colsXml += '</cols>';
                                $sheet.find('worksheet').prepend(colsXml);
                            },
                            exportOptions: {
                                columns: ':visible',
                                format: { body: function (data, row, col, node) { return col === 0 ? $(node).text() : data; } }
                            }
                        }
                    ],
                    "responsive": true,
                    "lengthChange": false,
                    "pageLength": 100,
                    "ordering": false,
                    "searching": true,
                    "autoWidth": false,
                    "destroy": true,

                    "fnRowCallback": function(nRow, aData, iDisplayIndex) {
                        var info = g_table.page.info();
                        var page = info.page;
                        var length = info.length;
                        var index = (page * length) + (iDisplayIndex + 1);
                        $('td:eq(0)', nRow).html(index);
                    }
                });

                $('#example1_filter input[type="search"]')
                    .attr('type', 'number')
                    .attr('placeholder', 'Search by Serial No...');
            }

            $(document).ready(function () {
                initializeDataTable();
            });
        </script>

        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive" style="overflow-x: auto;">
                                <table id="example1" class="table table-bordered table-striped" style="width: 100%;">
                                    <thead>
                                    <tr>
                                        <th style="min-width: 60px; white-space: nowrap;">Sr. No.</th>
                                        <th style="min-width: 120px; white-space: nowrap;">Record Serial No</th>
                                        <th style="min-width: 80px; white-space: nowrap;">Year</th>
                                        <th style="min-width: 130px; white-space: nowrap;">Date of Outgoing</th>
                                        <th style="min-width: 200px; white-space: nowrap;">Purpose</th>
                                        <th style="min-width: 150px; white-space: nowrap;">Section Person (Out)</th>
                                        <th style="min-width: 120px; white-space: nowrap;">Section Phone</th>
                                        <th style="min-width: 150px; white-space: nowrap;">Record Person (Out)</th>
                                        <th style="min-width: 130px; white-space: nowrap;">Date of Return</th>
                                        <th style="min-width: 150px; white-space: nowrap;">Section Person (In)</th>
                                        <th style="min-width: 130px; white-space: nowrap;">Section Phone (In)</th>
                                        <th style="min-width: 150px; white-space: nowrap;">Record Person (In)</th>
                                        <th style="min-width: 130px; white-space: nowrap;">Transaction Date</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</html>