<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div id="b-homedb" th:fragment="tabler">
    <div class="my-5">

        <h3 style="font-size:32px;" class="text-center mb-3 b-latest-data">Files's In Side / Received</h3>

        <script th:inline="javascript">
            $(function () {
              var g_table;
              var ajaxUrl = /*[[@{/callbook/load_callbook_data}]]*/ '';

              g_table = $('#example1').DataTable({
                "processing": true,
                "serverSide": true,
                "ajax": {
                  "url": ajaxUrl,
                  "type": "POST",
                  "contentType": "application/json",
                  "data": function (d) {
                    return JSON.stringify(d);
                  }
                },
                "columns": [
                  { "data": null, "searchable": false, "orderable": false },
                  { "data": "new_drSerialNo" },
                  { "data": "new_dr_year" },
                  { "data": "call_book_no" },
                  { "data": "possible_out_date" },
                  { "data": "sectionDealingHandName" },
                  { "data": "sectionDealingHandPhoneNo" },
                  { "data": "recordRoomDealingHandName" },
                  { "data": "in_out_status" },
                  { "data": "rack_no" }
                ],
                "responsive": true,
                "lengthChange": false,
                "autoWidth": false,
                "paging": true,
                "pageLength": 100,
                "searching": true,
                "ordering": false,
                "info": true,
                "destroy": true,
                dom: 'Bfrtip',
                buttons: [
                  {
                    extend: 'pdfHtml5',
                    text: 'Export PDF',
                    orientation: 'landscape',
                    className: 'btn btn-secondary mr-2',
                    filename: 'Call_Book_Files_List',
                    title: '',
                    customize: function (doc) {
                        doc.pageMargins = [40, 70, 40, 60];
                        doc.defaultStyle.fontSize = 10;
                        doc.content.unshift({
                            margin: [0, 0, 0, 12],
                            stack: [
                                { text: 'Erode District Administration', fontSize: 16, bold: true, alignment: 'center' },
                                { text: 'Record Room', fontSize: 11, alignment: 'center' },
                                { text: 'CALL BOOK FILES LIST', fontSize: 13, bold: true, alignment: 'center', margin: [0, 6, 0, 0] },
                                { text: 'Generated on: ' + new Date().toLocaleDateString(), fontSize: 9, alignment: 'center' }
                            ]
                        });
                        doc.styles.tableHeader = { fillColor: '#4CAF50', color: 'white', bold: true, alignment: 'center' };
                    },
                    exportOptions: {
                        columns: ':visible',
                        format: { body: function (data, row, col, node) { return col === 0 ? $(node).text() : data; } }
                    }
                  },
                  {
                    extend: 'excelHtml5',
                    text: 'Export Excel',
                    className: 'btn btn-secondary',
                    filename: 'Call_Book_Files_List',
                    title: '',
                    sheetName: 'Report',
                    customize: function (xlsx) {
                        var sheet = xlsx.xl.worksheets['sheet1.xml'];
                        var $sheet = $(sheet);
                        var styles = xlsx.xl['styles.xml'];
                        $(styles).find('xf').each(function () {
                            var xf = $(this);
                            if (xf.attr('xfId') === '0') {
                                xf.attr('applyAlignment', '1');
                                if (!xf.find('alignment').length) {
                                    xf.append('<alignment horizontal="center" vertical="center"/>');
                                }
                            }
                        });
                        $('row', sheet).each(function () {
                            var r = parseInt($(this).attr('r'));
                            $(this).attr('r', r + 5);
                            $('c', this).each(function () {
                                var ref = $(this).attr('r');
                                var col = ref.replace(/[0-9]/g, '');
                                $(this).attr('r', col + (r + 5));
                            });
                        });
                        var today = new Date().toLocaleDateString();
                        var sheetData = $('sheetData', sheet);
                        sheetData.prepend(
                            '<row r="1" ht="28" customHeight="1"><c r="A1" t="inlineStr" s="51"><is><t>Erode District Administration</t></is></c></row>' +
                            '<row r="2" ht="22" customHeight="1"><c r="A2" t="inlineStr" s="51"><is><t>Record Room</t></is></c></row>' +
                            '<row r="3" ht="20" customHeight="1"><c r="A3" t="inlineStr" s="51"><is><t>Generated on: ' + today + '</t></is></c></row>' +
                            '<row r="4" ht="26" customHeight="1"><c r="A4" t="inlineStr" s="51"><is><t>CALL BOOK FILES LIST</t></is></c></row>' +
                            '<row r="5"></row>'
                        );
                        var mergeCells = $sheet.find('mergeCells');
                        if (!mergeCells.length) {
                            mergeCells = $('<mergeCells count="0"/>');
                            $sheet.append(mergeCells);
                        }
                        mergeCells.append('<mergeCell ref="A1:J1"/>');
                        mergeCells.append('<mergeCell ref="A2:J2"/>');
                        mergeCells.append('<mergeCell ref="A3:J3"/>');
                        mergeCells.append('<mergeCell ref="A4:J4"/>');
                        var currentCount = parseFloat(mergeCells.attr('count')) || 0;
                        mergeCells.attr('count', currentCount + 4);
                        var colWidths = [];
                        $('row', sheet).each(function () {
                            var r = parseInt($(this).attr('r'));
                            if (r > 5) {
                                $('c', this).each(function (i) {
                                    var text = $('t', this).text();
                                    var len = text ? text.length : 0;
                                    colWidths[i] = Math.max(colWidths[i] || 10, len);
                                });
                            }
                        });
                        var colsXml = '<cols>';
                        colWidths.forEach(function (w, i) {
                            colsXml += '<col min="' + (i + 1) + '" max="' + (i + 1) + '" width="' + Math.min(w + 5, 50) + '"/>';
                        });
                        colsXml += '</cols>';
                        $sheet.find('worksheet').prepend(colsXml);
                    },
                    exportOptions: {
                        columns: ':visible',
                        format: { body: function (data, row, col, node) { return col === 0 ? $(node).text() : data; } }
                    }
                  }
                ],

                "fnRowCallback": function(nRow, aData, iDisplayIndex) {
                  var info = g_table.page.info();
                  var page = info.page;
                  var length = info.length;
                  var index = (page * length) + (iDisplayIndex + 1);
                  $('td:eq(0)', nRow).html(index);

                  var status = aData.in_out_status;
                  $('td:eq(8)', nRow).html(status === 0 ? 'InSide' : 'OutSide');

                  var dateIn = aData.possible_out_date;
                  if (dateIn) {
                      try {
                          var date = new Date(dateIn);
                          var formattedDate = date.getDate().toString().padStart(2, '0') + '-' +
                                            (date.getMonth() + 1).toString().padStart(2, '0') + '-' +
                                            date.getFullYear();
                          $('td:eq(4)', nRow).html(formattedDate);
                      } catch(e) {
                           $('td:eq(4)', nRow).html(dateIn);
                      }
                  }
                }
              });

              var searchInput = $('#example1_filter input[type="search"]');
              searchInput.attr('type', 'number');
              searchInput.attr('placeholder', 'Search by DR Serial No...');
            });
        </script>

        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"></h3>
                        </div>
                        <div class="card-body">
                            <table id="example1" class="table table-bordered table-striped">
                                <thead>
                                <tr>
                                    <th>Sr. No.</th>
                                    <th>DR Serial No</th>
                                    <th>DR Year</th>
                                    <th>Call Book Serial No</th>
                                    <th>Due Date</th>
                                    <th>Section Dealing Hand Name</th>
                                    <th>Section Dealing Hand Phone No</th>
                                    <th>Record Room Dealing Hand Name</th>
                                    <th>Status</th>
                                    <th>Rack No</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
</html>